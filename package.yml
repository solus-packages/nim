name       : nim
version    : 1.2.0
release    : 12
source     :
    - https://nim-lang.org/download/nim-1.2.0-linux_x64.tar.xz : ef043d5b46afb3fc3d654e88680b51f138fa2e843745af3ab355a6f65cf998a6
homepage   : https://nim-lang.org/
license    : MIT
component  : programming
summary    : Nim programming language
description: |
    Nim is a statically typed, imperative programming language.
setup      : |
    %patch < $pkgfiles/0001-Change-to-correct-dirs.patch
builddeps  :
    - nodejs-devel # check
rundeps    :
    - glibc-devel
    - linux-headers
build      : |
    ./build.sh
    bin/nim c koch
    ./koch boot -d:release
    ./koch tools -d:release

install    : |
    ./install.sh %installroot%

    install -Dm00755 bin/* $installdir/usr/bin
    install -Dm00644 tools/nim.bash-completion $installdir/usr/share/bash-completion/completions/nim
    install -Dm00644 dist/nimble/nimble.bash-completion $installdir/usr/share/bash-completion/completions/nimble
    mv $installdir%libdir%/nim/compiler.nimble $installdir%libdir%/nim/compiler/
    # compiler directory should not be part of binary package according to https://nim-lang.github.io/Nim/packaging.html
    rm -r $installdir%libdir%/nim/compiler

    
    # remove overview.html and /usr/share/nim/ directory from binary package
    rm -r $installdir/usr/share/nim

check      : |
    # don't test everything because it's too long
    export PATH=$workdir/bin:$PATH
    for cat in lib async float io bind rodfiles js debugger global threads
    do
        ./koch tests --pedantic category $cat -d:nimCoroutines || (echo "$cat test category failed" &&  exit 1)
    done